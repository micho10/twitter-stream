@(message: String)(implicit request: RequestHeader)

@main(message) {

    <!-- The container in which the messages will be displayed-->
    <div id="messages"></div>
    
    <script type="text/javascript">
        function appendMessage(text) {
            var p = document.createElement("p");
            var message = document.createTextNode(text);
            p.appendChild(message);
            document.getElementById("messages").appendChild(p);
        }

        var url = "@routes.Application.messages().webSocketURL()";
        var socket = new WebSocket(url);
        socket.onmessage = function(event) {
            console.log(event);
            var data = JSON.parse(event.data);
            appendMessage(data.text)
        };

        /*
         * Encapsulates the WebSocket connection logic in a reusable function
         */
        function connect(attempt) {
            var connectionAttempt = attempt;
            var url = "@routes.Application.messages().webSocketURL()";
            // Initializes the WebSocket connection using a URL generated by Play
            var messageSocket = new WebSocket(url);
            messageSocket.onmessage = function (event) {
                console.log(event);
                var data = JSON.parse(event.data);
                appendMessage(data.text)
            };
            // The handler called when the connection is opened
            messageSocket.onopen = function() {
                connectionAttempt = 1;
                // sends a subscription request to the server
                messageSocket.send("subscribe");
            };
            // The onclose handler, called when the WebSocket connection is closed
            messageSocket.onclose = function() {
                // Attempts up to 3 connection retries
                if (connectionAttempt <= 3) {
                    appendMessage("WARNING: Lost server connection, attempting to reconnect. Attempt number " + connectionAttempt);
                    // Executes the wrapped function call after a delay of 5000 milliseconds
                    setTimeout(function() {
                        // Attempts reconnection and increments the number of retries
                        connect(connectionAttempt + 1);
                    }, 5000);
                } else {
                    // In case of failure, alerts the user with a more prominent alert
                    alert("The connection with the server was lost")
                }
            }
        }
        // Indicates the first connection attempt
        connect(1)
    </script>

    @play20.welcome(message)
}
