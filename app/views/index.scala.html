@(message: String)(implicit request: RequestHeader)

@main(message) {
    <!-- The container in which the tweets will be displayed-->
    <div id="tweets"></div>
    <script type="text/javascript">
        function appendTweet(text) {
            var tweet = document.createElement("p");
            var message = document.createTextNode(text);
            tweet.appendChild(message);
            document.getElementById("tweets").appendChild(tweet);
        }

        /*
         * Encapsulates the WebSocket connection logic in a reusable function
         */
        function connect(attempt) {
            var connectionAttempt = attempt;
            var url = "@routes.Application.tweets().webSocketURL()";
            // Initializes the WebSocket connection using a URL generated by Play
            var tweetSocket = new WebSocket(url);
            tweetSocket.onmessage = function (event) {
                console.log(event);
                var data = JSON.parse(event.data);
                appendTweet(data.text)
            };
            // The handler called when the connection is opened
            tweetSocket.onopen = function() {
                connectionAttempt = 1;
                // sends a subscription request to the server
                tweetSocket.send("subscribe");
            };
            // The onclose handler, called when the WebSocket connection is closed
            tweetSocket.onclose = function() {
                // Attempts up to 3 connection retries
                if (connectionAttempt <= 3) {
                    appendTweet("WARNING: Lost server connection, attempting to reconnect. Attempt number " + connectionAttempt);
                    // Executes the wrapped function call after a delay of 5000 milliseconds
                    setTimeout(function() {
                        // Attempts reconnection and increments the number of retries
                        connect(connectionAttempt + 1);
                    }, 5000);
                } else {
                    // In case of failure, alerts the user with a more prominent alert
                    alert("The connection with the server was lost")
                }
            }
        }

        // Indicates the first connection attempt
        connect(1)
    </script>

    @play20.welcome(message)

}
